#!/bin/bash

# ==================================================
# MedHistory Unified Deploy Script
# ==================================================
# –ï–¥–∏–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ –≤—Å–µ—Ö —Å—Ä–µ–¥–∞—Ö
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   ./deploy local              # –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
#   ./deploy staging            # –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ä–µ–¥–∞
#   ./deploy production         # Production –¥–µ–ø–ª–æ–π
#
# –û–ø—Ü–∏–∏:
#   --rebuild       –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã
#   --no-backup     –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–∞–ø (–¥–ª—è staging/prod)
#   --monitoring    –í–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
#   --clean-data    ‚ö†Ô∏è –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï (volumes) - –¥–ª—è production —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
#   --update        –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–¥ (–±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤)
# ==================================================

set -e

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã
DEPLOY_ENV="${1:-local}"
shift || true

# –û–ø—Ü–∏–∏
REBUILD=false
NO_BACKUP=false
WITH_MONITORING=false
CLEAN_DATA=false
UPDATE_ONLY=false

# –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
while [[ $# -gt 0 ]]; do
    case $1 in
        --rebuild)
            REBUILD=true
            shift
            ;;
        --no-backup)
            NO_BACKUP=true
            shift
            ;;
        --monitoring)
            WITH_MONITORING=true
            shift
            ;;
        --clean-data)
            CLEAN_DATA=true
            shift
            ;;
        --update)
            UPDATE_ONLY=true
            shift
            ;;
        *)
            echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è: $1"
            echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: ./deploy [local|staging|production] [–æ–ø—Ü–∏–∏]"
            echo ""
            echo "–û–ø—Ü–∏–∏:"
            echo "  --rebuild       –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑—ã"
            echo "  --no-backup     –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å –±—ç–∫–∞–ø"
            echo "  --monitoring    –í–∫–ª—é—á–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥"
            echo "  --update        –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏)"
            echo "  --clean-data    ‚ö†Ô∏è  –£–î–ê–õ–ò–¢–¨ –í–°–ï –î–ê–ù–ù–´–ï –ë–î (–¥–ª—è prod —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ)"
            exit 1
            ;;
    esac
done

# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/scripts/config.sh" "$DEPLOY_ENV"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ä–µ–¥—ã (—á—Ç–æ–±—ã –æ–Ω–∏ –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª–∏)
case "$ENV_NAME" in
    local)
        PROJECT_NAME="medhistory-local"
        ;;
    staging)
        PROJECT_NAME="medhistory-staging"
        ;;
    production)
        PROJECT_NAME="medhistory"
        ;;
    *)
        PROJECT_NAME="medhistory"
        ;;
esac

# –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
print_header "üöÄ MedHistory Deploy - $(echo $ENV_NAME | tr '[:lower:]' '[:upper:]')"
print_env_info

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if ! check_env_file; then
    exit 1
fi

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_env

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ "$IS_REMOTE" = true ]; then
    if ! check_prod_config; then
        exit 1
    fi
    # –ü–µ—Ä–µ—Ñ–æ—Ä–º–∏—Ä–æ–≤—ã–≤–∞–µ–º PROD_SERVER –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ env —Ñ–∞–π–ª–∞
    export PROD_SERVER="${PROD_SERVER_USER}@${PROD_SERVER_IP}"
fi

# –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if [ -f "${SCRIPTS_DIR}/utils/validate-config.sh" ]; then
    print_info "üîç –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    if ! "${SCRIPTS_DIR}/utils/validate-config.sh" "$ENV_NAME"; then
        print_error "–í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞! –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ $ENV_FILE"
        exit 1
    fi
fi

# ==================================================
# –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
# ==================================================
if [ "$IS_REMOTE" = false ]; then
    print_header "üì¶ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ - ${ENV_NAME}"
    
    cd "$PROJECT_ROOT"
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    if [ "$CLEAN_DATA" = true ]; then
        print_warning "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ë—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –í–°–ï –î–ê–ù–ù–´–ï –ë–î!"
        read -p "–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–≤–µ–¥–∏—Ç–µ 'YES' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " confirmation
        if [ "$confirmation" != "YES" ]; then
            print_error "–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
            exit 1
        fi
        print_info "üóëÔ∏è  –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö..."
        docker compose -p $PROJECT_NAME $COMPOSE_FILES --env-file "$ENV_FILE" down -v
    else
        print_info "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–¥–∞–Ω–Ω—ã–µ –ë–î —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è)..."
        docker compose -p $PROJECT_NAME $COMPOSE_FILES --env-file "$ENV_FILE" down || true
    fi
    
    # –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if [ "$UPDATE_ONLY" = false ]; then
        if [ "$REBUILD" = true ]; then
            print_info "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
            docker compose -p $PROJECT_NAME $COMPOSE_FILES --env-file "$ENV_FILE" build --no-cache
        else
            print_info "üî® –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–æ–≤..."
            docker compose -p $PROJECT_NAME $COMPOSE_FILES --env-file "$ENV_FILE" build
        fi
    else
        print_info "‚ö° –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤)..."
    fi
    
    # –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
    print_info "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
    docker compose -p $PROJECT_NAME $COMPOSE_FILES --env-file "$ENV_FILE" up -d
    
    # –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    if [ "$WITH_MONITORING" = true ]; then
        print_info "üìä –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
        docker compose -p $PROJECT_NAME $MONITORING_COMPOSE --env-file "$ENV_FILE" up -d
    fi
    
    # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    print_info "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."
    sleep 10
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
    print_info "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
    docker compose -p $PROJECT_NAME $COMPOSE_FILES --env-file "$ENV_FILE" ps
    
    # –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    print_header "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
    echo ""
    print_success "üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
    
    case "$ENV_NAME" in
        local)
            echo "   ‚Ä¢ Frontend:         http://localhost:5173"
            echo "   ‚Ä¢ Backend API:      http://localhost:8000"
            echo "   ‚Ä¢ API Docs:         http://localhost:8000/docs"
            echo "   ‚Ä¢ MinIO Console:    http://localhost:9001"
            if [ "$WITH_MONITORING" = true ]; then
                echo "   ‚Ä¢ Grafana:          http://localhost:3000"
                echo "   ‚Ä¢ Prometheus:       http://localhost:9090"
            fi
            ;;
        staging)
            echo "   ‚Ä¢ Frontend:         http://localhost:8080"
            echo "   ‚Ä¢ Backend API:      http://localhost:8001"
            echo "   ‚Ä¢ API Docs:         http://localhost:8001/docs"
            echo "   ‚Ä¢ MinIO Console:    http://localhost:9011"
            if [ "$WITH_MONITORING" = true ]; then
                echo "   ‚Ä¢ Grafana:          http://localhost:3001"
                echo "   ‚Ä¢ Prometheus:       http://localhost:9091"
            fi
            ;;
    esac
    
    echo ""
    print_info "üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
    echo "   ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:    docker compose -p $PROJECT_NAME $COMPOSE_FILES --env-file $ENV_FILE logs -f"
    echo "   ‚Ä¢ –û—Å—Ç–∞–Ω–æ–≤–∫–∞:         docker compose -p $PROJECT_NAME $COMPOSE_FILES --env-file $ENV_FILE stop"
    echo "   ‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫:        ./deploy $ENV_NAME"
    echo ""

# ==================================================
# –£–¥–∞–ª–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (Production)
# ==================================================
else
    print_header "üåê –£–¥–∞–ª–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ Production"
    
    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è --clean-data –Ω–∞ production
    if [ "$CLEAN_DATA" = true ]; then
        print_warning "‚ö†Ô∏è  ‚ö†Ô∏è  ‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –£–î–ê–õ–ï–ù–ò–ï –í–°–ï–• –î–ê–ù–ù–´–• –ë–î –ù–ê PRODUCTION!"
        print_warning "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ. –í—Å–µ –¥–∞–Ω–Ω—ã–µ PostgreSQL, MongoDB –∏ MinIO –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã."
        read -p "–í—ã –ê–ë–°–û–õ–Æ–¢–ù–û —É–≤–µ—Ä–µ–Ω—ã? –í–≤–µ–¥–∏—Ç–µ 'DELETE ALL DATA' –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è: " confirmation
        if [ "$confirmation" != "DELETE ALL DATA" ]; then
            print_error "–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
            exit 1
        fi
        print_warning "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö..."
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    print_info "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É ${PROD_SERVER}..."
    if ! ssh -o ConnectTimeout=5 "${PROD_SERVER}" "echo 'Connected'" > /dev/null 2>&1; then
        print_error "–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É"
        echo "  –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
        echo "    - IP –∞–¥—Ä–µ—Å: $PROD_SERVER_IP"
        echo "    - SSH –∫–ª—é—á–∏: ~/.ssh/"
        echo "    - –§–∞–π—Ä–≤–æ–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
        exit 1
    fi
    print_success "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
    print_info "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
    TEMP_ARCHIVE="/tmp/medhistory_deploy_$(date +%Y%m%d_%H%M%S).tar.gz"
    
    tar --exclude='node_modules' \
        --exclude='backend/__pycache__' \
        --exclude='backend/app/__pycache__' \
        --exclude='frontend/dist' \
        --exclude='.git' \
        --exclude='backups' \
        --exclude='.env*' \
        --exclude='._*' \
        --exclude='.DS_Store' \
        -czf "${TEMP_ARCHIVE}" \
        -C "$(dirname "${PROJECT_ROOT}")" \
        "$(basename "${PROJECT_ROOT}")"
    
    print_success "–ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω: ${TEMP_ARCHIVE}"
    
    # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    print_info "‚¨ÜÔ∏è  –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
    ssh "${PROD_SERVER}" "mkdir -p ~/medhistory_temp"
    scp "${TEMP_ARCHIVE}" "${PROD_SERVER}:~/medhistory_temp/project.tar.gz"
    scp "$ENV_FILE" "${PROD_SERVER}:~/medhistory_temp/.env.production"
    print_success "–§–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
    
    # –£–¥–∞–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞—Ä—Ö–∏–≤–∞
    rm "${TEMP_ARCHIVE}"
    
    # –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    print_info "üîß –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
    
    # –ü–µ—Ä–µ–¥–∞—á–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ SSH —Å–µ—Å—Å–∏—é
    ssh "${PROD_SERVER}" "CLEAN_DATA=$CLEAN_DATA NO_BACKUP=$NO_BACKUP REBUILD=$REBUILD UPDATE_ONLY=$UPDATE_ONLY WITH_MONITORING=$WITH_MONITORING bash" <<ENDSSH
set -e

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "\${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\${NC}"
echo -e "\${YELLOW}Production Deployment\${NC}"
echo -e "\${YELLOW}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\${NC}"

# –§–ª–∞–≥–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "Debug: CLEAN_DATA=$CLEAN_DATA, NO_BACKUP=$NO_BACKUP"

# –ë—ç–∫–∞–ø –µ—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è
if [ -d ~/medhistory ] && [ "$NO_BACKUP" != true ]; then
    echo -e "\${YELLOW}üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞...${NC}"
    if [ -f ~/medhistory/scripts/utils/backup.sh ]; then
        cd ~/medhistory
        ./scripts/utils/backup.sh || echo "‚ö†Ô∏è  –ë—ç–∫–∞–ø –Ω–µ —É–¥–∞–ª—Å—è"
    fi
    
    echo -e "\${YELLOW}üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    cd ~/medhistory
    
    # –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Ñ–ª–∞–≥ --clean-data
    if [ "$CLEAN_DATA" = true ]; then
        echo -e "\${RED}‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• –¥–∞–Ω–Ω—ã—Ö –ë–î (volumes)!${NC}"
        docker compose -f docker-compose.base.yml -f docker-compose.prod.yml --env-file .env.production down -v || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"
    else
        docker compose -f docker-compose.base.yml -f docker-compose.prod.yml --env-file .env.production down || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"
    fi
    
    echo -e "\${YELLOW}üìÅ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏...${NC}"
    mv ~/medhistory ~/medhistory_old_\$(date +%Y%m%d_%H%M%S)
fi

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
echo -e "\${YELLOW}üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏...${NC}"
cd ~
tar -xzf ~/medhistory_temp/project.tar.gz
mv "\$(tar -tzf ~/medhistory_temp/project.tar.gz | head -1 | cut -f1 -d"/")" medhistory
cp ~/medhistory_temp/.env.production ~/medhistory/.env.production

# –û—á–∏—Å—Ç–∫–∞ temp
rm -rf ~/medhistory_temp

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
cd ~/medhistory

if [ "$UPDATE_ONLY" = true ]; then
    echo -e "\${YELLOW}‚ö° –ë—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ –æ–±—Ä–∞–∑–æ–≤)...${NC}"
    echo -e "\${YELLOW}üöÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker compose -f docker-compose.base.yml -f docker-compose.prod.yml --env-file .env.production up -d --force-recreate
else
    echo -e "\${YELLOW}üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤...${NC}"
    if [ "$REBUILD" = true ]; then
        docker compose -f docker-compose.base.yml -f docker-compose.prod.yml --env-file .env.production build --no-cache
    else
        docker compose -f docker-compose.base.yml -f docker-compose.prod.yml --env-file .env.production build
    fi
    
    echo -e "\${YELLOW}üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...${NC}"
    docker compose -f docker-compose.base.yml -f docker-compose.prod.yml --env-file .env.production up -d
fi

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if [ "$WITH_MONITORING" = true ]; then
    echo -e "\${YELLOW}üìä –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...${NC}"
    docker compose -f docker-compose.monitoring.prod.yml --env-file .env.production up -d
fi

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo -e "\${YELLOW}‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ (30 —Å–µ–∫)...${NC}"
sleep 30

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo -e "\${YELLOW}üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:${NC}"
docker compose -f docker-compose.base.yml -f docker-compose.prod.yml ps

echo -e "\${GREEN}‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!${NC}"
ENDSSH
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    print_header "‚úÖ Production –¥–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
    echo ""
    print_success "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
    echo "   ‚Ä¢ Frontend:  http://${PROD_SERVER_IP}"
    echo "   ‚Ä¢ API Docs:  http://${PROD_SERVER_IP}/docs"
    echo "   ‚Ä¢ Health:    http://${PROD_SERVER_IP}/health"
    if [ "$WITH_MONITORING" = true ]; then
        echo "   ‚Ä¢ Grafana:   http://${PROD_SERVER_IP}:3000"
    fi
    echo ""
    print_info "üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤:"
    echo "   ssh ${PROD_SERVER} 'cd ~/medhistory && docker compose -f docker-compose.base.yml -f docker-compose.prod.yml logs -f'"
    echo ""
fi

print_success "üéâ –ì–æ—Ç–æ–≤–æ!"

