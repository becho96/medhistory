name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch, tag or commit SHA to deploy'
        required: true
        default: 'main'
        type: string
      service:
        description: 'Service to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - backend
          - frontend

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  DEPLOY_PATH: ~/medhistory

jobs:
  deploy:
    name: Deploy ${{ inputs.service }} from ${{ inputs.ref }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        run: |
          echo "ðŸš€ Deploying ${{ inputs.service }} from ref: ${{ inputs.ref }}"
          
          # Sync files to server (excluding sensitive and generated files)
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'node_modules' \
            --exclude '__pycache__' \
            --exclude '.env' \
            --exclude '.env.production' \
            --exclude 'venv' \
            --exclude '*.pyc' \
            --exclude '.DS_Store' \
            --exclude 'frontend/.env' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:${{ env.DEPLOY_PATH }}/
          
          # Build and restart containers using production compose file
          if [ "${{ inputs.service }}" = "all" ]; then
            ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "cd ${{ env.DEPLOY_PATH }} && docker compose -f docker-compose.prod.yml build --no-cache && docker compose -f docker-compose.prod.yml up -d"
          elif [ "${{ inputs.service }}" = "backend" ]; then
            ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "cd ${{ env.DEPLOY_PATH }} && docker compose -f docker-compose.prod.yml build --no-cache backend && docker compose -f docker-compose.prod.yml up -d backend"
          elif [ "${{ inputs.service }}" = "frontend" ]; then
            ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "cd ${{ env.DEPLOY_PATH }} && docker compose -f docker-compose.prod.yml build --no-cache frontend && docker compose -f docker-compose.prod.yml up -d frontend"
          fi

      - name: Health check
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10
          
          echo "ðŸ” Checking frontend health..."
          curl -sf --max-time 10 http://${{ secrets.SERVER_IP }}/ > /dev/null && echo "âœ… Frontend is healthy" || echo "âš ï¸ Frontend check failed"
          
          echo "ðŸ” Checking API through nginx proxy..."
          curl -sf --max-time 10 http://${{ secrets.SERVER_IP }}/docs > /dev/null && echo "âœ… API is healthy" || echo "âš ï¸ API check failed"
          
          echo "ðŸ” Checking health endpoint..."
          curl -sf --max-time 10 http://${{ secrets.SERVER_IP }}/health > /dev/null && echo "âœ… Health check passed" || echo "âš ï¸ Health check failed"

      - name: Deployment summary
        run: |
          echo "## ðŸŽ‰ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Ref** | \`${{ inputs.ref }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | ${{ inputs.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Server** | ${{ secrets.SERVER_IP }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Frontend](http://${{ secrets.SERVER_IP }}/)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Documentation](http://${{ secrets.SERVER_IP }}/docs)" >> $GITHUB_STEP_SUMMARY
          echo "- [API Endpoint](http://${{ secrets.SERVER_IP }}/api/v1/)" >> $GITHUB_STEP_SUMMARY

