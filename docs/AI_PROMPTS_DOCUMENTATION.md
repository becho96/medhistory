# Документация AI-промптов и логики анализа

> Описание всех промптов и логики работы с LLM-моделями в системе "История болезни"

## Оглавление

1. [Общая архитектура](#общая-архитектура)
2. [Анализ и классификация документа](#1-анализ-и-классификация-документа)
3. [Извлечение результатов анализов](#2-извлечение-результатов-анализов)
4. [Генерация медицинского отчёта](#3-генерация-медицинского-отчёта)
5. [AI-интерпретация результатов](#4-ai-интерпретация-результатов)
6. [Категоризация анализов](#5-категоризация-анализов)

---

## Общая архитектура

### Используемый API
- **Провайдер**: OpenRouter (`https://openrouter.ai/api/v1/chat/completions`)
- **Модель по умолчанию**: `anthropic/claude-3.5-sonnet`
- **Конфигурация**: `backend/app/core/config.py`

### Параметры запросов

| Параметр | Значение | Описание |
|----------|----------|----------|
| `max_tokens` | 2000 (стандарт) / 50 (категоризация) | Максимальная длина ответа |
| `temperature` | 0.1 (извлечение) / 0 (категоризация) | Низкая для консистентности |
| `timeout` | 60 сек (стандарт) / 30 сек (категоризация) | Таймаут HTTP-запроса |

### Схема потока данных

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  Загрузка файла │ ──▶ │ analyze_document │ ──▶ │   PostgreSQL    │
│  (PDF/Image)    │     │   (промпт #1)    │     │   + MongoDB     │
└─────────────────┘     └──────────────────┘     └─────────────────┘
                               │
                               ▼ (если тип = "Результаты анализа")
                        ┌──────────────────┐
                        │extract_lab_results│
                        │   (промпт #2)    │
                        └──────────────────┘
```

---

## 1. Анализ и классификация документа

### Расположение
- **Файл**: `backend/app/services/ai_service.py`
- **Метод**: `analyze_document()`
- **Промпт**: `_build_extraction_prompt()`

### Логика работы

1. **Определение типа файла**:
   - PDF → извлечение текста через PyPDF2
   - Изображение (JPG/PNG) → отправка как base64 в vision API

2. **Обработка PDF**:
   ```python
   text_content = self._extract_text_from_pdf(file_bytes)
   # Если текста < 50 символов → ошибка (требуется OCR)
   ```

3. **Обработка изображений**:
   ```python
   file_base64 = base64.b64encode(file_bytes).decode('utf-8')
   # Отправляется как image_url с data URI
   ```

4. **Сохранение результата**:
   - PostgreSQL: `document_type`, `document_date`, `patient_name`, `medical_facility`
   - MongoDB: `classification` (подтип, область, специальности), `extracted_data` (summary)

### Промпт #1: Классификация документа

```
Проанализируй этот медицинский документ и извлеки следующую информацию в формате JSON.

# ОБЯЗАТЕЛЬНАЯ СТРУКТУРА JSON:

{
  "document_type": "ОБЯЗАТЕЛЬНО - один из 5 типов",
  "document_subtype": "условно обязательно",
  "research_area": "только для инструментальных исследований",
  "specialties": ["массив специальностей"],
  "document_date": "YYYY-MM-DD",
  "patient_name": "Фамилия И.О.",
  "medical_facility": "название учреждения",
  "document_language": "ru|en",
  "confidence": 0.95,
  "summary": "краткое содержание"
}

# ТИПЫ ДОКУМЕНТОВ (выбери ОДИН из 5):

1. "Прием врача" - амбулаторный прием, консультация, медицинское заключение врача
2. "Результаты анализа" - лабораторные анализы любого типа
3. "Инструментальное исследование" - УЗИ, МРТ, КТ, рентген, маммография
4. "Функциональная диагностика" - ЭКГ, ЭЭГ, холтер, спирометрия, ФГДС, колоноскопия
5. "Другое" - если не подходит ни под одну категорию

# ПРАВИЛА ЗАПОЛНЕНИЯ ПО ТИПАМ:

## "Прием врача":
- specialties: ["Кардиология", "Терапия"] - ОБЯЗАТЕЛЬНО массив (минимум 1)
- document_subtype: null
- research_area: null

Справочник специальностей: Терапия, Кардиология, Неврология, Гастроэнтерология, 
Эндокринология, Урология, Оториноларингология (ЛОР), Офтальмология, 
Травматология и ортопедия, Дерматология, Инфекционные болезни, Ревматология, 
Пульмонология, Нефрология, Онкология, Хирургия, Акушерство и гинекология, 
Педиатрия, Психиатрия, Другая специальность

## "Результаты анализа":
- document_subtype: "Общий анализ крови" - ОБЯЗАТЕЛЬНО
- specialties: null
- research_area: null

Подтипы: Общий анализ крови, Биохимический анализ крови, Общий анализ мочи, 
Анализ кала, Бактериологический анализ, Серологический анализ, 
Гистологическое исследование, Цитологическое исследование, 
Иммунологический анализ, Гормональный анализ, Генетический анализ, Другой анализ

## "Инструментальное исследование":
- document_subtype: "УЗИ" - ОБЯЗАТЕЛЬНО
- research_area: "Брюшная полость" - рекомендуется
- specialties: null

Подтипы: УЗИ, МРТ, КТ, Рентген, Маммография, Флюорография, Ангиография, Другое исследование

Области для УЗИ: Брюшная полость, Щитовидная железа, Молочные железы, 
Органы малого таза, Сердце (ЭхоКГ), Сосуды, Суставы, Мягкие ткани, Другая область

Области для МРТ/КТ: Головной мозг, Позвоночник, Брюшная полость, Грудная клетка, 
Суставы, Мягкие ткани, Сосуды, Другая область

Области для Рентген: Грудная клетка, Позвоночник, Суставы, Кости конечностей, 
Черепа, Другая область

## "Функциональная диагностика":
- document_subtype: "ЭКГ (электрокардиография)" - ОБЯЗАТЕЛЬНО
- specialties: null
- research_area: null

Подтипы: ЭКГ (электрокардиография), ЭЭГ (электроэнцефалография), 
Холтер-мониторирование, Суточный мониторинг АД, Спирометрия, Велоэргометрия, 
ФГДС (фиброгастродуоденоскопия), Колоноскопия, Бронхоскопия, 
Другая функциональная диагностика

## "Другое":
- Все дополнительные параметры опциональны
- confidence должна быть низкой (<0.5)

# ОБЩИЕ ПРАВИЛА:

1. document_type - ВСЕГДА ОБЯЗАТЕЛЬНО, используй точное название из списка выше
2. Дата документа - это дата процедуры/приема, НЕ дата печати
3. Формат ФИО: "Иванов И.И." (с точками)
4. Специальности (specialties) - СУЩЕСТВИТЕЛЬНЫЕ: "Кардиология", а НЕ "Кардиолог"
5. Если информация не найдена - используй null
6. confidence (0.0-1.0) - твоя уверенность в классификации
7. document_language - код языка ("ru", "en")

# ВАЖНО:
- Отвечай ТОЛЬКО валидным JSON
- Без дополнительного текста
- Проверь, что структура соответствует типу документа
```

### Парсинг ответа

```python
# Извлечение JSON из ответа (может быть обёрнут в markdown)
if "```json" in content:
    content = content.split("```json")[1].split("```")[0].strip()
elif "```" in content:
    content = content.split("```")[1].split("```")[0].strip()

data = json.loads(content)
```

---

## 2. Извлечение результатов анализов

### Расположение
- **Файл**: `backend/app/services/ai_service.py`
- **Метод**: `extract_lab_results()`
- **Промпт**: `_build_labs_extraction_prompt()`

### Логика работы

1. **Триггер**: Автоматически запускается, если `document_type == "Результаты анализа"`
2. **Входные данные**: Те же, что для `analyze_document()` (PDF-текст или изображение)
3. **Сохранение**: MongoDB → `extracted_data.lab_results[]`

### Промпт #2: Извлечение лабораторных результатов

```
Определи, есть ли в документе результаты лабораторных анализов. 
Если да, извлеки их в JSON по стандартизованной схеме.

Стандартизованный формат:
{
  "lab_results": [
    {
      "test_name": "название анализа (например: гемоглобин, глюкоза)",
      "value": "числовое значение как строка",
      "unit": "единицы измерения (например: г/л, ммоль/л, %)",
      "reference_range": "референсный диапазон как строка (например: 120-160)",
      "flag": "L|N|H|A"  // L ниже нормы, N норма, H выше нормы, A абнормально/критично
    }
  ]
}

Правила:
- Если анализов нет, верни {"lab_results": []}
- test_name на русском языке, как в документе, но без лишнего шума
- value оставляй строкой, не округляй
- ВАЖНО: unit должен точно соответствовать единицам измерения из документа
  * Если указаны проценты (%), обязательно указывай "%" в unit
  * Если указаны абсолютные значения (например, 10*9/л, х10^9/л, г/л), указывай их точно как в документе
  * Разные единицы измерения одного анализа (например, процентные и абсолютные) - это РАЗНЫЕ биомаркеры
  * Не смешивай единицы: если в документе "Лимфоциты 42%" и "Лимфоциты 2.5 10*9/л", это две отдельные записи
- Если единиц нет, используй null
- Если референс нет, используй null
- Определи flag исходя из референсного диапазона, если он указан
- Отвечай ТОЛЬКО валидным JSON

Примеры правильного извлечения:
- "Лимфоциты 42%" → {"test_name": "Лимфоциты", "value": "42", "unit": "%", ...}
- "Лимфоциты 2.5 10*9/л" → {"test_name": "Лимфоциты", "value": "2.5", "unit": "10*9/л", ...}
- "Гемоглобин 145 г/л" → {"test_name": "Гемоглобин", "value": "145", "unit": "г/л", ...}
- "Гемоглобин 14.5 г/дл" → {"test_name": "Гемоглобин", "value": "14.5", "unit": "г/дл", ...}
```

### Структура результата

```json
{
  "lab_results": [
    {
      "test_name": "Гемоглобин",
      "value": "145",
      "unit": "г/л",
      "reference_range": "120-160",
      "flag": "N"
    },
    {
      "test_name": "Лейкоциты",
      "value": "12.5",
      "unit": "10*9/л",
      "reference_range": "4.0-9.0",
      "flag": "H"
    }
  ]
}
```

---

## 3. Генерация медицинского отчёта

### Расположение
- **Файл**: `backend/app/services/ai_service.py`
- **Метод**: `generate_report_content()`
- **Файл вызова**: `backend/app/services/report_service.py`

### Логика работы

1. **Входные данные**: Список документов, отфильтрованных по параметрам пользователя
2. **Подготовка контекста**: Формируется текстовое описание каждого документа
3. **Результат**: Текст отчёта → генерируется PDF через ReportLab

### Промпт #3: Генерация отчёта

```
Создай подробный медицинский отчёт для пациента на основе следующих документов:

{context}

Отчёт должен включать:
1. Общую информацию о пациенте
2. Хронологическую временную линию событий
3. Ключевые результаты анализов и исследований
4. Назначенное лечение и его динамику
5. Резюме текущего состояния здоровья

Формат отчёта должен быть структурированным с четкими заголовками.
Пиши на русском языке.
Будь профессиональным и детальным.
```

### Формат контекста документа

```
Дата: 2024-01-15
Тип: Прием врача
Пациент: Иванов И.И.
Учреждение: Городская поликлиника №1
Файл: consultation_15012024.pdf

---

Дата: 2024-01-20
Тип: Результаты анализа
...
```

---

## 4. AI-интерпретация результатов

### Расположение
- **Файл**: `backend/app/services/interpretation_service.py`
- **Метод**: `_generate_interpretation()`
- **Промпт**: `_build_interpretation_prompt()`

### Логика работы

1. **Входные данные**: Выбранные пользователем документы с результатами анализов
2. **Сбор данных**: Из PostgreSQL (базовые поля) + MongoDB (lab_results, summary)
3. **Результат**: Текстовая интерпретация, сохраняется в таблице `interpretations`

### Системный промпт

```
Ты медицинский AI-ассистент, специализирующийся на интерпретации результатов анализов.
Твоя задача - предоставить понятное для пациента объяснение результатов анализов.

ВАЖНЫЕ ПРАВИЛА:
1. Используй осторожные, не категоричные формулировки
2. НЕ ставь диагнозы
3. Используй понятный для пациента язык
4. Будь эмпатичным
5. При критических отклонениях настоятельно рекомендуй обратиться к врачу
6. Если показатели в норме - явно укажи на это для снижения тревожности
```

### Промпт #4: Интерпретация результатов

```
Проанализируй следующие медицинские документы пациента и предоставь интерпретацию:

## Общая информация
- Всего документов: {total_docs}
- Документов с результатами анализов: {docs_with_labs}
- Общее количество показателей: {total_lab_results}

## Документы

### Документ 1
- Файл: blood_test.pdf
- Тип: Результаты анализа
- Подтип: Общий анализ крови
- Дата: 2024-01-15
- Учреждение: Инвитро

**Результаты анализов (12 показателей):**
- Гемоглобин: 145 г/л (референс: 120-160) ✅ Норма
- Лейкоциты: 12.5 10*9/л (референс: 4.0-9.0) ⬆️ Выше нормы
- Тромбоциты: 180 10*9/л (референс: 150-400) ✅ Норма
...

**Краткое содержание:**
Общий анализ крови с развёрнутой лейкоцитарной формулой.

---

Предоставь подробную интерпретацию в следующей структуре:

1. **Общая оценка** - краткое резюме о состоянии показателей 
   (норма/требует внимания/требует консультации врача)

2. **Анализ показателей** - разбор по категориям или системам организма:
   - Какие показатели в норме
   - Какие показатели отклонены (с указанием степени отклонения)
   - Что могут означать эти отклонения (в общих чертах, БЕЗ диагнозов)

3. **Динамика** (если есть несколько анализов во времени):
   - Какие показатели улучшились
   - Какие показатели ухудшились
   - Какие остались стабильными

4. **Рекомендации**:
   - Общие рекомендации (без назначения лечения!)
   - Нужно ли обратиться к врачу и к какому специалисту
   - На что обратить внимание

5. **Важное напоминание** - обязательно укажи дисклеймер о том, что:
   - Это не заменяет консультацию врача
   - Интерпретация носит информационный характер
   - Рекомендуется обсудить результаты с лечащим врачом

Пиши на русском языке, простым и понятным для пациента языком.
Если показатели в норме - обязательно успокой пациента и явно укажи на это.
При критических отклонениях настоятельно рекомендуй немедленно обратиться к врачу.
```

### Иконки статуса в промпте

| Flag | Иконка | Описание |
|------|--------|----------|
| `L` | ⬇️ | Ниже нормы |
| `H` | ⬆️ | Выше нормы |
| `A` | ⚠️ | Критично |
| `N` | ✅ | Норма |

---

## 5. Категоризация анализов

### Расположение
- **Файл**: `backend/app/services/analyte_category_service.py`
- **Метод**: `_determine_category_with_ai()`

### Логика работы

1. **Триггер**: Когда название анализа не найдено в справочнике `ANALYTE_STANDARDS`
2. **Кэширование**: Результат сохраняется в MongoDB коллекцию `analyte_category_cache`
3. **Параметры запроса**: `max_tokens=50`, `temperature=0`

### Известные категории

```python
KNOWN_CATEGORIES = [
    "Общий анализ крови",
    "Биохимия крови",
    "Липидный профиль",
    "Коагулограмма",
    "Гормоны",
    "Витамины и микроэлементы",
    "Маркеры воспаления",
    "Общий анализ мочи",
    "Инфекции",
    "Микробиология",
    "Онкомаркеры",
    "Аутоиммунные маркеры",
    "Другое"
]
```

### Промпт #5: Категоризация анализа

```
Определи категорию медицинского анализа.

Название анализа: {test_name}
Единица измерения: {unit}  # опционально

Выбери ОДНУ категорию из списка:
- Общий анализ крови
- Биохимия крови
- Липидный профиль
- Коагулограмма
- Гормоны
- Витамины и микроэлементы
- Маркеры воспаления
- Общий анализ мочи
- Инфекции
- Микробиология
- Онкомаркеры
- Аутоиммунные маркеры
- Другое

Ответь ТОЛЬКО названием категории, без объяснений.
```

### Пост-обработка ответа

```python
category = response["choices"][0]["message"]["content"].strip()

# Проверка точного совпадения
if category in KNOWN_CATEGORIES:
    return category

# Нечёткое совпадение
for known_cat in KNOWN_CATEGORIES:
    if known_cat.lower() in category.lower() or category.lower() in known_cat.lower():
        return known_cat

# Fallback
return "Другое"
```

---

## Обработка ошибок

### Общий паттерн

```python
try:
    response_data = await self._call_openrouter(messages)
    # Парсинг результата...
except Exception as e:
    print(f"❌ AI analysis failed: {str(e)}")
    return DocumentMetadata(
        document_type="неизвестно",
        confidence=0.0,
        summary=f"Не удалось автоматически проанализировать документ: {str(e)}"
    )
```

### Типичные ошибки

| Ошибка | Причина | Обработка |
|--------|---------|-----------|
| `HTTPStatusError` | Проблемы с API | Логирование, возврат defaults |
| `JSON parse error` | Некорректный JSON в ответе | Попытка извлечь из markdown-блока |
| `Timeout` | Долгий ответ модели | 60 сек таймаут, затем ошибка |
| `PDF < 50 chars` | Отсканированный PDF без OCR | Явная ошибка пользователю |

---

## Рекомендации по модификации промптов

1. **Тестирование**: При изменении промптов тестируйте на разных типах документов
2. **JSON-валидация**: Модель иногда возвращает JSON в markdown — парсер это учитывает
3. **Temperature**: Для извлечения данных держите низкую (0-0.1)
4. **Справочники**: При добавлении новых типов/категорий обновляйте списки в промптах
5. **Язык**: Промпты на русском дают лучшие результаты для русскоязычных документов

---

*Документ создан: Январь 2026*  
*Версия: 1.0*

