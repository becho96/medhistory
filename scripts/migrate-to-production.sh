#!/bin/bash

# ============================================================
# –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω
# ============================================================
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./scripts/migrate-to-production.sh
# ============================================================

set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
PROJECT_ROOT="$( cd "$SCRIPT_DIR/.." && pwd )"

echo -e "${BLUE}============================================================${NC}"
echo -e "${BLUE}üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∞–Ω–∞–ª–∏–∑–æ–≤: LOCAL ‚Üí PRODUCTION${NC}"
echo -e "${BLUE}============================================================${NC}"
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ–∞–π–ª–æ–≤
echo -e "${YELLOW}üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è...${NC}"

if [ ! -f "$PROJECT_ROOT/.env.local" ]; then
    echo -e "${RED}‚ùå –§–∞–π–ª .env.local –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì .env.local –Ω–∞–π–¥–µ–Ω${NC}"

if [ ! -f "$PROJECT_ROOT/.env.production" ]; then
    echo -e "${RED}‚ùå –§–∞–π–ª .env.production –Ω–µ –Ω–∞–π–¥–µ–Ω!${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì .env.production –Ω–∞–π–¥–µ–Ω${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Python
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}‚ùå Python 3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!${NC}"
    exit 1
fi
echo -e "${GREEN}‚úì Python 3 –Ω–∞–π–¥–µ–Ω: $(python3 --version)${NC}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo
echo -e "${YELLOW}üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ asyncpg –∏ python-dotenv
if ! python3 -c "import asyncpg" 2>/dev/null; then
    echo -e "${YELLOW}‚ö† asyncpg –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...${NC}"
    pip3 install asyncpg
fi
echo -e "${GREEN}‚úì asyncpg —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"

if ! python3 -c "import dotenv" 2>/dev/null; then
    echo -e "${YELLOW}‚ö† python-dotenv –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é...${NC}"
    pip3 install python-dotenv
fi
echo -e "${GREEN}‚úì python-dotenv —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω${NC}"

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
echo
echo -e "${BLUE}============================================================${NC}"
echo -e "${BLUE}‚ñ∂ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏...${NC}"
echo -e "${BLUE}============================================================${NC}"
echo

cd "$PROJECT_ROOT"
python3 "$SCRIPT_DIR/migrate-analyte-tables-ssh.py"

exit_code=$?

echo
if [ $exit_code -eq 0 ]; then
    echo -e "${GREEN}============================================================${NC}"
    echo -e "${GREEN}‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!${NC}"
    echo -e "${GREEN}============================================================${NC}"
else
    echo -e "${RED}============================================================${NC}"
    echo -e "${RED}‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π${NC}"
    echo -e "${RED}============================================================${NC}"
fi

exit $exit_code
